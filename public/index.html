<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TY VOLE .wtf ‚Äî vibe generator</title>
<meta name="description" content="Gen-Z hl√°≈°ky, chat a p≈ôekladaƒç Gen-Z ‚Üî norm√°ln√≠ ƒçe≈°tina. Instant vibe generator, no cap fr fr üî•">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://ty-vole.wtf/">
<meta property="og:title" content="TY VOLE .wtf ‚Äî instant vibe generator">
<meta property="og:description" content="Gen-Z hl√°≈°ky, chat a p≈ôekladaƒç. Pos√≠lej s rozvahou. üî•">
<meta property="og:image" content="/brand/og-image.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:url" content="https://ty-vole.wtf/">
<meta name="twitter:title" content="TY VOLE .wtf ‚Äî instant vibe generator">
<meta name="twitter:description" content="Gen-Z hl√°≈°ky, chat a p≈ôekladaƒç. Pos√≠lej s rozvahou. üî•">
<meta name="twitter:image" content="https://ty-vole.wtf/icons/og-image.png">

<!-- PWA + ikony -->
<link rel="manifest" href="/manifest.webmanifest?v=5">
<meta name="theme-color" content="#111111">
<link rel="icon" href="/icons/icon-192.v5.png" sizes="192x192">
<link rel="apple-touch-icon" href="/icons/icon-192.v5.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ty-vole">

<!-- Share system CSS -->
<link rel="stylesheet" href="lib/share.css">

<!-- Update Chip CSS -->
<link rel="stylesheet" href="lib/update-chip.css">

<!-- Privacy-friendly analytics by Plausible -->
<script async src="https://plausible.io/js/pa-XhYv5mHfTkNZArOLGPADs.js"></script>
<script>
  window.plausible = window.plausible || function() {
    (plausible.q = plausible.q || []).push(arguments)
  }, plausible.init = plausible.init || function(i) {
    plausible.o = i || {};
  };
  plausible.init()
</script>

<style>
  :root{
    /* New design system colors */
    --bg-0:#0A0A0A;
    --bg-1:#080808;
    --bg-2:#0E0E0E;
    --text:#F4F4F4;
    --muted:#BDBDBD;

    --lime:#B8FF4D;     /* jemnƒõj≈°√≠ zelen√° */
    --cyan:#27F1E2;     /* mƒõkƒç√≠ tyrkys */
    --pink:#FF5FA6;

    --card: rgba(18,18,18,.70); /* polopr≈Øhledn√©! */
    --radius:18px;
    --gap:22px;
    
    /* Legacy compatibility */
    --ink:var(--text);
    --bg:var(--bg-0);
    --accent:var(--lime);
    --ink-dark:#0c0c10;
    --line:#252536;
    
    /* Translator specific */
    --tvl-green:#22ff99;
    --tvl-green-2:#00ffaa;
    --card-bg:#0e0e0e;
    --field-bg:#1a1a1a;
    --border:#333;
  }
  
  *{box-sizing:border-box}
  
  /* iOS safe-area support */
  :root{
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);
    --safe-right: env(safe-area-inset-right, 0px);
  }
  
  html, body{
    /* Jemnƒõ pohybliv√Ω gradient pozad√≠ */
    background: radial-gradient(120% 120% at 10% 0%, #0d0d0d 0%, #070707 45%, #0e0e0e 100%);
    background-size: 140% 140%;
    color: var(--text);
    /* Fix iOS viewport height issues - enable scroll */
    min-height: 100dvh;
    height: auto;
    overflow-y: auto;
    overflow-x: hidden;
  }
  
  @media (prefers-reduced-motion:no-preference){
    body{
      animation: bgShift 16s ease-in-out infinite alternate;
    }
    @keyframes bgShift{
      from{ background-position: 0% 0%; }
      to  { background-position: 100% 50%; }
    }
  }
  
  body{
    margin:0;
    font:16px/1.5 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial;
    min-height:100dvh;
    padding:28px;
    padding-top: calc(28px + var(--safe-top));
    padding-bottom: calc(140px + var(--safe-bottom)); /* Space for fixed footer CTA */
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    /* CRITICAL: Remove fixed positioning to allow scroll */
    position:relative;
    width:100%;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior-y: contain;
  }

  /* === MEGA BACKGROUND WORDMARK (cel√° obrazovka) === */
  .bg-wordmark{
    position:fixed; inset:0; display:flex; flex-direction:column; justify-content:space-between;
    /* CRITICAL: pointer-events none to not block clicks */
    pointer-events:none; 
    z-index:0; 
    overflow:hidden; 
    padding:5vh 0;
  }
  .bg-wordmark span{
    font-weight:900; white-space:nowrap;
    font-size:14vh;
    letter-spacing:-0.8vw;
    color:#ffe0f0;                /* svƒõtlej≈°√≠ r≈Ø≈æov√° */
    opacity:.32;
    text-shadow:0 18px 90px rgba(255,224,240,.6);
    user-select:none;
  }
  .bg-top{
    align-self:flex-start;
    transform:translateX(-8vw) rotate(-4deg) scaleX(0.7) scaleY(2.5);
  }
  .bg-bottom{
    align-self:flex-end;
    transform:translateX(8vw) rotate(3deg) scaleX(0.7) scaleY(2.5);
  }

  .wrap{
    width:min(980px,100%); 
    position:relative; 
    z-index:1;
    /* Ensure content is accessible and not cut off */
    margin-bottom: 2rem;
  }
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  .brand{display:flex;gap:10px;align-items:center;font-weight:900;letter-spacing:.02em}
  .brand .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(90deg,var(--accent),var(--cyan));box-shadow:0 0 16px rgba(157,255,0,.7)}
  .brand span{opacity:.66}
  .chips{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .chip{border:1px solid var(--line);color:var(--muted);background:#1a1a1a;padding:8px 12px;border-radius:999px;font-size:13px;transition: all .2s ease;}
  .chip.btn{cursor:pointer;color:var(--ink-dark);background:linear-gradient(90deg,var(--lime),#CFFF85);border:0;font-weight:900}
  
  /* Active chip with softer pulse animation */
  .chip-active{
    background: linear-gradient(90deg,var(--lime),#CFFF85);
    color:#031;
    font-weight:900;
    border:0;
    box-shadow: 0 0 0 2px rgba(184,255,77,.25) inset;
  }
  
  @media (prefers-reduced-motion:no-preference){
    @keyframes pulse-glow{
      0%,100%{ box-shadow:0 0 0 2px rgba(184,255,77,.28) inset; }
      50%{ box-shadow:0 0 0 8px rgba(184,255,77,0) inset; }
    }
    .chip-active{
      animation: pulse-glow 2.2s ease-in-out infinite;
    }
  }

  /* Karta - pr≈Øsvitn√° bez ƒçern√©ho r√°meƒçku */
  .card{
    background: var(--card); /* polopr≈Øhledn√© rgba(18,18,18,.70) */
    border: none !important;
    outline: none !important;
    border-radius: var(--radius);
    padding: 18px;
    backdrop-filter: blur(6px) saturate(1.05); /* sklo efekt */
    -webkit-backdrop-filter: blur(6px) saturate(1.05);
    box-shadow: 0 6px 26px rgba(0,0,0,.35);
    max-width: 680px;
    margin-inline:auto;
    margin-bottom:0.5rem;
  }
  .card + .card{ margin-top: var(--gap); }
  
  /* Zru≈°it tvrd√© p≈ôekryt√≠ pokud existuje */
  .card::before,
  .section::before,
  .wrapper::before{
    background: transparent !important;
    box-shadow: none !important;
    opacity: 0 !important;
  }
  h1{margin:0 0 6px;font-size:clamp(28px,7vw,56px);line-height:1.1;letter-spacing:-.02em}
  .subtitle{color:var(--muted);font-weight:600;font-size:14px}
  .quote{margin:18px 0 6px;font-weight:900;font-size:clamp(22px,4.5vw,40px);letter-spacing:-.015em; min-height:2.4em}
  .trans{color:var(--muted);font-size:15px;margin-top:2px}
  /* Section spacing */
  .section { padding: 0 var(--gap); margin: var(--gap) 0; }
  
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  
  /* Button system - 3 hierarchy levels */
  button, .btn{
    appearance:none;
    border:0;
    cursor:pointer;
    font-weight:700;
    padding:14px 18px;
    border-radius:14px;
    line-height:1;
    transition: transform .15s ease, box-shadow .2s ease;
  }
  
  .btn:focus-visible, button:focus-visible{
    outline:2px solid color-mix(in oklab, var(--text), transparent 60%);
    outline-offset:2px;
  }
  
  @media (prefers-reduced-motion:no-preference){
    .btn:hover, button:hover{
      transform: translateY(-1px);
    }
  }
  
  /* Primary ‚Äì hlavn√≠ akce (Drop/Share) s neon glow */
  .btn-primary{
    background: linear-gradient(90deg, var(--lime), #CFFF85);
    color:#072;
    border:none;
    box-shadow:
      0 10px 28px rgba(184,255,77,.18),
      0 0 0 2px rgba(184,255,77,.18) inset;
    transform: translateZ(0);
  }
  
  @media (prefers-reduced-motion:no-preference){
    .btn-primary:hover{
      filter: drop-shadow(0 0 10px rgba(184,255,77,.35));
    }
  }
  
  /* Secondary ‚Äì download */
  .btn-secondary{
    background: linear-gradient(90deg, var(--cyan), #7DF7EB);
    color:#062;
    box-shadow:0 10px 30px rgba(39,241,226,.12);
  }
  
  /* Tertiary ‚Äì copy link / boomer mode */
  .btn-tertiary{
    background: transparent;
    color: var(--text);
    border:1px solid color-mix(in oklab, var(--text), transparent 75%);
  }
  
  /* Legacy compat */
  .primary{color:var(--ink-dark);background:linear-gradient(90deg,var(--lime),var(--cyan))}
  .ghost{color:var(--text);background:transparent;border:1px solid var(--line)}
  .tiny{font-size:13px;padding:8px 12px}
  
  /* CTA tlaƒç√≠tka grid - pou≈æ√≠v√° hierarchy syst√©m */
  .btn-group{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
    width:100%;
    margin-top:8px;
  }
  
  #copy{
    grid-column:1 / -1; /* Tertiary p≈ôes celou ≈°√≠≈ôku */
  }
  
  /* Responzivn√≠ - na √∫zk√©m mobilu stack vertik√°lnƒõ */
  @media(max-width:480px){
    .btn-group{
      grid-template-columns:1fr;
    }
    #copy{
      grid-column:1;
    }
  }

  footer{margin-top:12px;display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px}
  .mode{display:flex;gap:6px;align-items:center}
  .mode button{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:transparent;color:var(--muted);font-weight:700}
  .mode button.active{border-color:var(--accent);color:var(--ink)}

  .cta{
    position:fixed;
    right:18px;
    bottom: calc(18px + var(--safe-bottom));
    width:min(380px,calc(100% - 36px));
    z-index:2;
    /* Ensure it doesn't block content with pointer-events */
    pointer-events: auto;
  }
  
  .footer-cta{
    border:1px solid color-mix(in oklab, var(--cyan), transparent 60%);
    border-radius:20px;
    padding:16px;
    background:rgba(18,18,18,.92);
    backdrop-filter:saturate(140%) blur(8px);
    transition:transform .2s ease, box-shadow .2s ease;
  }
  
  .footer-cta:hover{
    transform:translateY(-2px);
    box-shadow:0 24px 70px rgba(0,0,0,.6);
  }
  
  .footer-cta a{
    display:block;
    color:var(--cyan);
    font-weight:900;
    text-decoration:none;
    font-size:18px;
    letter-spacing:-0.01em;
  }
  
  @media (prefers-reduced-motion:no-preference){
    @keyframes arrow-bounce{
      0%,100%{ transform:translateX(0);}
      50%{ transform:translateX(4px);}
    }
    .footer-cta .arrow{
      display:inline-block;
      animation: arrow-bounce 1.4s ease-in-out infinite;
    }
  }
  .cta small{display:block;color:var(--muted);margin-top:6px}
  
  /* Daily Tracks */
  .daily-tracks-section{
    margin-top:2rem;
    margin-bottom:1rem;
    padding:0;
    display:flex;
    justify-content:center;
    align-items:center;
    flex-direction:column;
    /* Ensure it's visible and accessible */
    position: relative;
    z-index: 1;
    scroll-margin-top: 24px;
  }
  
  .daily-tracks-section .subtitle{
    display:inline-block;
    margin-bottom:1rem;
    text-align:center;
  }
  
  .daily-nav{
    display:inline-flex;
    gap:.5rem;
    margin-left:1rem;
    vertical-align:middle;
  }
  
  .daily-nav button{
    width:32px;
    height:32px;
    border-radius:50%;
    border:1px solid var(--line);
    background:var(--card);
    color:var(--text);
    font-size:16px;
    cursor:pointer;
    transition:all .2s ease;
  }
  
  .daily-nav button:hover:not(:disabled){
    background:var(--line);
    transform:scale(1.05);
  }
  
  .daily-nav button:disabled{
    opacity:.3;
    cursor:not-allowed;
  }
  
  .daily-tracks-grid{
    display:flex;
    gap:1rem;
    justify-content:center;
    max-width:320px;
    margin:0 auto;
    padding:0.75rem 0.5rem;
    background:rgba(255,255,255,0.05);
    border-radius:14px;
  }
  
  .dtile{
    display:flex;
    flex-direction:column;
    gap:.5rem;
    width:84px;
  }
  
  .dtile__cover{
    position:relative;
    width:84px;
    height:84px;
    border-radius:10px;
    overflow:hidden;
  }
  
  .dtile__cover a{
    display:block;
    width:100%;
    height:100%;
  }
  
  .dtile__img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
    border-radius:10px;
  }
  
  .dtile__placeholder{
    width:100%;
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:10px;
    opacity:.6;
    background:#f1f3f5;
    border-radius:10px;
    color:#868e96;
  }
  
  .preview-badge{
    position:absolute;
    right:4px;
    bottom:4px;
    padding:2px 6px;
    font-size:10px;
    border-radius:10px;
    background:#fff;
    color:#000;
    box-shadow:0 1px 4px rgba(0,0,0,.2);
    border:none;
    cursor:pointer;
    font-weight:600;
    transition:transform .15s ease;
  }
  
  .preview-badge:hover{
    transform:scale(1.05);
  }
  
  .preview-badge:active{
    transform:scale(0.95);
  }
  
  .preview-badge:disabled{
    opacity:.5;
    cursor:not-allowed;
  }
  
  .dtile__meta{
    font-size:0.72rem;
    line-height:1.1;
  }
  
  .dtile__title{
    font-weight:600;
    color:var(--text);
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    font-size:0.72rem;
    line-height:1.1;
  }
  
  .dtile__artists{
    color:var(--muted);
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    font-size:0.72rem;
    line-height:1.1;
  }
  
  @media (max-width:480px){
    body{
      padding:16px;
      padding-top: calc(16px + var(--safe-top));
      padding-bottom: calc(160px + var(--safe-bottom));
    }
    
    .daily-tracks-grid{
      gap:.75rem;
      max-width:280px;
    }
    .dtile{
      width:80px;
    }
    .dtile__cover{
      width:80px;
      height:80px;
    }
    .dtile__meta{
      font-size:10px;
    }
    .daily-nav{
      display:flex;
      margin-left:0;
      margin-top:.5rem;
    }
  }
  
  /* Translator AI card - unified design */
  .translator{
    margin:0;
    background:var(--card-bg);
    border:1px solid color-mix(in oklab, var(--tvl-green) 30%, #0b7);
    border-radius:16px;
    padding:1rem;
    box-shadow:0 0 15px rgba(34,255,153,.15);
    transition:box-shadow .3s ease, transform .2s ease;
  }

  .translator:hover{ box-shadow:0 0 25px rgba(34,255,153,.25); }

  .translator.translated{ animation: tvl-glow .9s ease; }
  @keyframes tvl-glow{
    0%{ box-shadow:0 0 0 rgba(34,255,153,0); }
    30%{ box-shadow:0 0 28px rgba(34,255,153,.45); }
    100%{ box-shadow:0 0 15px rgba(34,255,153,.15); }
  }

  .translator-inner{ display:flex; flex-direction:column; gap:.75rem; }
  .translator-inputs{ display:flex; flex-direction:column; gap:.75rem; }

  .translator textarea{
    width:100%;
    background:var(--field-bg);
    color:#fff;
    border:1px solid var(--border);
    border-radius:12px;
    padding:.75rem 1rem;
    font:16px/1.5 "Inter",system-ui,sans-serif;
    resize:none;
    min-height:80px;
    transition:border-color .2s ease, box-shadow .2s ease;
  }
  .translator textarea:focus{
    border-color:var(--tvl-green);
    outline:none;
    box-shadow:0 0 0 3px color-mix(in oklab, var(--tvl-green) 30%, transparent);
  }

  .translator-label{
    color:#9ae6b4;
    font:600 13px/1.2 Inter,system-ui,sans-serif;
    margin-top:.25rem;
    margin-bottom:.35rem;
    display:block;
    letter-spacing:.2px;
  }

  .translator-actions{
    display:flex; justify-content:flex-end; gap:.5rem;
  }

  .translator-actions button{
    background:linear-gradient(90deg, var(--tvl-green), var(--tvl-green-2));
    color:#000; font-weight:600;
    border:0; border-radius:10px; padding:.6rem 1.2rem;
    cursor:pointer; transition:transform .08s ease, opacity .2s ease;
  }
  .translator-actions button:hover{ transform:scale(1.05); opacity:.92; }

  #clearBtn{
    background:#262626; color:#fff; border:1px solid var(--border);
  }
  
  /* bottom sheet (translator) */
  .sheet-backdrop{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.45);
    display:none; 
    z-index:10;
  }
  .sheet{
    position:fixed;
    left:0;
    right:0;
    bottom:0;
    max-height:70dvh;
    background:#11121a;
    border-top:1px solid var(--line);
    border-radius:18px 18px 0 0;
    transform:translateY(100%);
    transition:.2s ease-out; 
    z-index:11;
    padding-bottom: var(--safe-bottom);
  }
  .sheet.open{transform:translateY(0)}
  .sheet-backdrop.show{display:block}
  .sheet .head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line)}
  .sheet .body{padding:14px 16px}
  .cols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  textarea{width:100%;min-height:120px;background:#0f1016;color:var(--ink);border:1px solid var(--line);border-radius:12px;padding:12px;font:15px/1.5 ui-sans-serif,system-ui}
  .smallrow{display:flex;gap:8px;margin-top:8px}
</style>
</head>
<body>
  <!-- big background wordmark -->
  <div class="bg-wordmark">
    <span class="bg-top">TY VOLE</span>
    <span class="bg-bottom">.WTF</span>
  </div>

  <div class="wrap">
    <header>
      <div class="brand">
        <img src="/brand/tvl-logo.svg" alt="TY VOLE" aria-label="TY VOLE" style="height:28px;display:inline-block;">
        <div class="dot"></div>
        <div>TY&nbsp;VOLE<span>.wtf</span></div>
      </div>
      <div class="chips">
        <div class="chip">#skibidi</div><div class="chip">#rizz</div><div class="chip">#based</div><div class="chip">#drip</div>
        <button id="btnSheet" class="chip btn chip-active" aria-label="Otev≈ô√≠t Skibidi p≈ôekladaƒç">Skibidi p≈ôekladaƒç</button>
      </div>
    </header>

    <div class="card">
      <div class="subtitle">Instant vibe generator</div>
      <div class="quote" id="quote">‚Ä¶naƒç√≠t√°m fresh hl√°≈°ku‚Ä¶</div>
      <div class="trans" id="quoteTranslated" style="display:none;"></div>

      <div class="row">
        <button id="next" class="primary">Dal≈°√≠ shot üî•</button>
        <label class="chip" style="cursor:pointer;">
          <input id="chkAutoTrans" type="checkbox" style="vertical-align:middle;margin-right:6px;"> Dej p≈ôeklad
        </label>
      </div>
      
      <!-- CTA tlaƒç√≠tka - 3-level hierarchy -->
      <div class="btn-group">
        <button id="shareMain" class="btn btn-primary" aria-label="Sd√≠let kartu do chatu">
          <span id="shareMainText">Drop do chatu üíÄ</span>
        </button>
        <button id="downloadCard" class="btn btn-secondary" aria-label="St√°hnout kartu jako PNG">
          <span id="downloadText">Bake it üç∞</span>
        </button>
        <button id="copy" class="btn btn-tertiary" aria-label="Zkop√≠rovat odkaz">
          <span id="copyText">Boomer sharing mode</span>
        </button>
      </div>
      <div id="ctaMicrocopy" class="cta-microcopy" style="display:none;"></div>
    </div>

    <!-- Daily Tracks Section -->
    <section id="daily-tracks" class="daily-tracks-section" style="display:none;">
      <div class="subtitle" style="margin-bottom:1rem;">Today's Fresh Tracks üéµ</div>
      <div class="daily-tracks-grid"></div>
    </section>
  </div>

  <div class="cta footer-cta">
    <a href="/chat.html">M√°m i chat, bro üò≠ <span class="arrow">‚Üí</span></a>
  </div>

  <!-- Translator bottom sheet -->
  <div class="sheet-backdrop" id="backdrop"></div>
  <section class="sheet" id="sheet">
    <div class="head">
      <div style="display:flex;justify-content:flex-end;width:100%;">
        <button id="closeSheet" class="ghost tiny">Zav≈ô√≠t</button>
      </div>
    </div>
    <div class="body">
      <section id="translator-box" class="translator">
        <div class="translator-inner">
          <div class="translator-inputs">
            <label for="ta-normal" class="translator-label">Norm√°l</label>
            <textarea id="ta-normal" placeholder="Napi≈° bƒõ≈ænou ƒçe≈°tinou‚Ä¶" rows="3"></textarea>

            <label for="ta-skibidi" class="translator-label">Skibidi</label>
            <textarea id="ta-skibidi" placeholder="Napi≈° skibidi / Gen-Z style‚Ä¶" rows="3"></textarea>
          </div>

          <div class="translator-actions">
            <button id="clearBtn" type="button">Smazat üóëÔ∏è</button>
          </div>
        </div>
      </section>
      
      <div id="explanation" style="margin-top:16px;padding:12px;background:rgba(157,255,0,.05);border:1px solid rgba(157,255,0,.2);border-radius:12px;display:none;">
        <div style="font-weight:700;margin-bottom:8px;color:var(--accent);">üí° Co to znamen√°?</div>
        <div id="explanationText" style="font-size:14px;line-height:1.6;color:var(--muted);"></div>
      </div>
    </div>
  </section>

<script>
let MODE = (localStorage.getItem('mode') || 'genz');
let AUTO = localStorage.getItem('autoTrans') === '1';
const LAST = [];
let translationInProgress = false;

// ===== Lexikon =====
const L = { openers:[], tones_pos:[], tones_mid:[], tones_neg:[], verbs:[], nouns:[], actions:[], emotes:[], templates:[], quotes:[] };

const pick = arr => arr[Math.floor(Math.random()*arr.length)];
const uniquePick = (arr) => { let tries=0; while(tries<10){ const v=pick(arr); if(!LAST.includes(v)) return v; tries++; } return pick(arr); };

async function loadLexicon(){
  try{
    const lex = await fetch('/config/lexicon.json?v=20251102').then(r=>{
      if(!r.ok) throw new Error('lexicon fetch '+r.status);
      return r.json();
    });
    Object.assign(L, lex);
  }catch(e){
    Object.assign(L, { openers:["Hele"], templates:["No cap, dal≈°√≠."], quotes:["No cap, dal≈°√≠."] });
  }
}

// Bezpeƒçn√© dosazen√≠ placeholder≈Ø s fallbackem
function fillPlaceholders(template, dict = {}) {
  // Nahraƒè zn√°m√© kl√≠ƒçe {key} ‚Üí value
  let out = template.replace(/\{(\w+)\}/g, (_, key) => {
    const val = dict[key];
    return (val ?? '').toString();
  });
  
  // Fallback: cokoliv zbyde ve slo≈æen√Ωch z√°vork√°ch zahodit
  out = out.replace(/\{[^}]+\}/g, '').replace(/\s{2,}/g, ' ').trim();
  
  // Kosmetika: odstranit zbytky ƒç√°rek/teƒçek po vyhozen√≠ placeholderu
  out = out.replace(/\s*([,;:.!?])\s*/g, '$1 ').replace(/\s+$/, '');
  
  return out;
}

function compose(){
  if (Math.random() < 0.8 && L.templates.length){
    const tpl = uniquePick(L.templates);
    
    // Bezpeƒçn√© dosazen√≠ s fallbacky
    return fillPlaceholders(tpl, {
      opener: uniquePick(L.openers || ['']),
      tones_pos: uniquePick(L.tones_pos || ['']),
      tones_mid: uniquePick(L.tones_mid || ['']),
      tones_neg: uniquePick(L.tones_neg || ['']),
      verbs: uniquePick(L.verbs || ['']),
      nouns: uniquePick(L.nouns || ['']),
      actions: uniquePick(L.actions || ['']),
      emote: uniquePick(L.emotes || [''])
    });
  }
  return uniquePick(L.quotes.length ? L.quotes : ["No cap, dal≈°√≠."]);
}

function setUrlState(text, push=true){
  if (LAST.push(text)>10) LAST.shift();
  const url=new URL(location.href);
  url.searchParams.set('q', encodeURIComponent(text));
  url.searchParams.set('mode', MODE);
  history[push?'pushState':'replaceState'](null,'',url);
}

async function typeOut(el, text, speed=18){
  el.textContent = '';
  for (let i=0;i<text.length;i++){
    el.textContent += text[i];
    await new Promise(r=>setTimeout(r, speed));
  }
}

async function setQuoteTyped(text, push=true){
  const el = document.getElementById('quote');
  // Schov√°me p≈ôeklad bƒõhem psan√≠
  const transEl = document.getElementById('quoteTranslated');
  transEl.style.display='none';
  
  await typeOut(el, text);
  setUrlState(text, push);
  
  // Poƒçk√°me chvilku po dops√°n√≠, ne≈æ zaƒçneme p≈ôekl√°dat
  if(AUTO) {
    await new Promise(r=>setTimeout(r, 100));
    showAutoTranslation(text);
  }
}

/* ========= Lok√°ln√≠ p≈ôekladaƒç CZ <-> Gen-Z (regex-based) ========= */
const CZ2GZ_PHRASES = [
  [/(c√≠t√≠m|citim)\s+se\s+(hodnƒõ|hodne)\s+trapn(ƒõ|e)/gi, 'c√≠t√≠m se mega cringe'],
  [/(c√≠t√≠m|citim)\s+se\s+trapn(ƒõ|e)/gi, 'c√≠t√≠m se cringe'],
  [/bez\s+(srandy|kec≈Ø|kecu)/gi, 'no cap'],
  [/to\s+je\s+(pravda|real)/gi, 'no cap'],
  [/to\s+je\s+le≈æ/gi, 'cap']
];

const CZ2GZ_WORDS = [
  // Z√°kladn√≠ Gen-Z v√Ωrazy co u≈æ jsou Gen-Z - nech√°m je b√Ωt
  [/moment/gi, 'moment'],
  [/setup/gi, 'setup'],
  [/flow/gi, 'flow'],
  
  // SPECIFICK√â FR√ÅZE NEJD≈ò√çV (p≈ôed jednotliv√Ωmi slovy!)
  [/trapn(√Ω|√©ho|√©mu|√Ωm|√©m|√°|ou|√©|e|y|i)?\s+vtip/gi, 'dad joke'],
  [/strach\s+(z|ze)\s+zme(≈°|s)k(√°|a)n(√≠|√©ho|√≠mu|√≠m|√©m)?/gi, 'FOMO'],
  [/nejlep(≈°√≠|≈°√≠ho|≈°√≠mu|≈°√≠m|≈°em)?\s+(k(√°|a)mo(≈°|s|≈°e|≈°i|≈°em|≈°ovi)?|kamar(√°|a)d(a|y|u|em|ovi|ka|ce|ku|kou)?)/gi, 'bestie'],
  [/vztah\s+nevztah/gi, 'situationship'],
  [/mimo\s+realit(u|y|ƒõ)?/gi, 'delulu'],
  [/hniloba\s+mozku/gi, 'brain rot'],
  [/star(≈°√≠|≈°√≠ho)?\s+generac(e|i)/gi, 'boomer'],
  [/tr(√°|a)vit\s+(ƒç|c)as\s+s\s+p(≈ô|r)(√°|a)teli/gi, 'hangout'],
  [/u(ƒç|c)en(√≠|√©ho|√≠mu|√≠m|√©m)?\s+nejde/gi, 'academic victim'],
  [/varovn(√Ω|√©ho|√©mu|√Ωm|√©m|√°|ou|√©|e|y|i)?\s+sign(√°|a)l/gi, 'red flag'],
  [/pozitivn(√≠|√≠ho|√≠mu|√≠m|√©m|√°|ou|√©|i)?\s+sign(√°|a)l/gi, 'green flag'],
  [/neutr(√°|a)ln(√≠|√≠ho|√≠mu|√≠m|√©m|√°|ou|√©|i)?\s+sign(√°|a)l/gi, 'beige flag'],
  
  // DEL≈†√ç V√ùRAZY p≈ôed krat≈°√≠mi - ZJEDNODU≈†EN√â regex (matchuj√≠ v√≠c tvar≈Ø)
  [/\b(v[y√Ω]born[y√Ω√°√©ƒõ√≠√≥√∫≈Øaouei]+|vybornej|vyborny|v√Ωborn√©|v√Ωborn√Ω)\b/gi, 'bussin'],
  [/\bperfektn[√≠ƒõ√©aouei]+\b/gi, 'slay'],
  [/\blegend[a√°]rn[√≠ƒõ√©aouei]+\b/gi, 'goated'],
  [/\bautentick[y√Ω√°√©aouei]+\b/gi, 'based'],
  [/\btoxick[y√Ω√°√©aouei]+\b/gi, 'toxic'],
  [/\btrapn[y√Ω√°√©ƒõ√≠aouei]+\b/gi, 'cringe'],
  [/\bdivn[y√Ω√°√©ƒõ√≠aouei]+\b/gi, 'skibidi'],
  [/\bpr[u≈Ø]m[ƒõe]rn[y√Ω√°√©ƒõ√≠aouei]+\b/gi, 'mid'],
  [/\bnudn[y√Ω√°√©ƒõ√≠aouei]+\b/gi, 'mid'],
  [/\bzamilovan[y√Ω√°√©ƒõ√≠aouei]+\b/gi, 'crush'],
  [/\bbl[a√°]zniv[y√Ω√°√©ƒõ√≠aouei]+\b/gi, 'goofy'],
  [/\babsurdn[√≠ƒõ√©aouei]+\b/gi, 'unhinged'],
  [/\bz[a√°]bavn[y√Ω√°√©ƒõ√≠aouei]+\b/gi, 'lit'],
  [/\bpodez[r≈ô]el[y√Ω√°√©ƒõ√≠aouei]+\b/gi, 'sus'],
  [/\bp[r≈ô]ecitliv[ƒõeƒõ]l[y√Ω√°√©ƒõ√≠aouei]+\b/gi, 'snowflake'],
  [/\bignorov[a√°]n[√≠ƒõ√©aouei]+\b/gi, 'ghosting'],
  [/\bmanipulac[ei]\b/gi, 'gaslighting'],
  [/\bne[u√∫]sp[ƒõe][≈°s]n[y√Ω√°√©ƒõ√≠aouei]+\b/gi, 'fail'],
  [/\belegant(n[√≠ƒõ√©aouei]+)?\b/gi, 'classy'],
  [/\bzru[≈°s]en[y√Ω√°√©ƒõ√≠aouei]+\b/gi, 'cancelled'],
  [/\bunik[a√°]tn[√≠ƒõ√©aouei]+\b/gi, 'sigma'],
  [/\bnez[a√°]visl[y√Ω√°√©ƒõ√≠aouei]+\b/gi, 'sigma'],
  [/\bnaivn[√≠ƒõ√©aouei]+\b/gi, 'delulu'],
  [/\b[≈°s][t≈•]astn[y√Ω√°√©ƒõ√≠aouei]+\b/gi, 'blessed'],
  [/\beleg[a√°]ntn[√≠ƒõ√©aouei]+\b/gi, 'drip'],
  [/\bsm[ƒõe][≈°s]n[y√Ω√°√©ƒõ√≠aouei]+\b/gi, 'goofy'],
  
  // NEJBƒö≈ΩNƒöJ≈†√ç slova - MUST MATCH!
  [/\bdobr[y√Ω√°√©ƒõ√≠aouei]+\b/gi, 'fire'],
  [/\b[≈°s]patn[y√Ω√°√©ƒõ√≠aouei]+\b/gi, 'mid'],
  [/\bkr[a√°]sn[y√Ω√°√©ƒõ√≠aouei]+\b/gi, 'fire'],
  [/\bsuper\b/gi, 'bussin'],
  [/\bhezk[y√Ω√°√©ƒõ√≠aouei]+\b/gi, 'cute'],
  [/\b[≈°s]karedn[y√Ω√°√©ƒõ√≠aouei]+\b/gi, 'ugly'],
  [/\bhodn[ƒõe]\b/gi, 'hella'],
  [/\bdost\b/gi, 'lowkey'],
  [/\bmoc\b/gi, 'too much'],
  [/\bm[a√°]lo\b/gi, 'not enough'],
  [/\bopravdu\b/gi, 'fr'],
  [/\bv[a√°][≈æz]n[ƒõe]\b/gi, 'fr'],
  [/\bup[r≈ô][√≠i]mn[ƒõe]\b/gi, 'ngl'],
  [/up≈ô(√≠|i)mn(ƒõ|e)/gi, 'ngl'],
  [/\bcharism[ayuoueƒõ]+\b/gi, 'rizz'],
  [/\bdrb[yuoa√°≈Ø√°mami]+\b/gi, 'tea'],
  [/\bn[a√°]lad[ayuouƒõ]+\b/gi, 'vibe'],
  [/\batmosf[e√©]r[ayuouƒõ]+\b/gi, 'vibe'],
  [/\bstyl\b/gi, 'drip'],
  [/\bvibe\b/gi, 'vibe'],
  
  // Bƒö≈ΩN√Å SLOVA - dƒõlej, je, to, m√°m, jsi...
  [/\bjsem\b/gi, 'jsem'],
  [/\bje(s|≈°)t[ƒõe]\b/gi, 'je≈°tƒõ'],
  [/\bte[dƒè]\b/gi, 'rn'],
  [/\bpr[a√°]v[ƒõe]\b/gi, 'rn'],
  [/\bte[dƒè]ka\b/gi, 'rn'],
  [/\bm[a√°]m\b/gi, 'got'],
  [/\bnem[a√°]m\b/gi, "ain't got"],
  [/\bd[ƒõe]l[a√°][m≈°]\b/gi, 'doing'],
  [/\bjde(s|≈°)?\b/gi, 'going'],
  [/\bvid√≠(m|≈°)\b/gi, 'see'],
  [/\brozum[√≠i][m≈°]\b/gi, 'cap'],
  [/\bmysl[√≠i][m≈°]\b/gi, 'mean'],
  [/\bch(ce|t[ƒõe])[m≈°]?\b/gi, 'want'],
  [/\bpot[r≈ô]ebu(je|ji)[m≈°]?\b/gi, 'need'],
  [/\bm[u≈Ø][≈æz]e(me|te|≈°)?\b/gi, 'can'],
  [/\bmus[√≠i][m≈°]\b/gi, 'gotta'],
  
  // Akce a verba - ZJEDNODU≈†EN√â
  [/\bpos[√≠i]lit\b/gi, 'buff'],
  [/\boslabit\b/gi, 'nerf'],
  [/\bopravit\b/gi, 'fix'],
  [/\b[≈æz]vatlat\b/gi, 'yap'],
  [/\bbrblat\b/gi, 'yap'],
  [/\bpop[√≠i]jet\b/gi, 'hang out'],
  [/\bchlad(n[a√°]|nou)\b/gi, 'chill'],
  [/\bp[r≈ô]edv[a√°]d[ƒõe]t\s+se\b/gi, 'flex'],
  [/\bchlub(it\s+se|il|ila|ili)\b/gi, 'flexing'],
  [/\bprovokovat|provokuje|provokoval|provokovali\b/gi, 'trolling'],
  [/\bml(uv)[√≠i][m≈°]\b/gi, 'talkin'],
  [/\b[r≈ô][√≠i]k[a√°][m≈°]\b/gi, 'sayin'],
  [/\bvid[ƒõe]l(a|i)?\b/gi, 'saw'],
  [/\bsly[≈°s]el(a|i)?\b/gi, 'heard'],
  
  // Jednoduch√© v√Ωrazy
  [/\bextr[e√©]mn[ƒõe]\b/gi, 'AF'],
  [/\bnejlep[≈°s][√≠i]\b/gi, 'GOAT'],
  [/\bchyba\b/gi, 'L'],
  [/\bselh[a√°]n[√≠i]\b/gi, 'fail'],
  [/\bpodiv[√≠i]n\b/gi, 'weirdo'],
  [/\bcool\b/gi, 'fire'],
  [/\bh[r≈ô][√≠i][≈°s]n[√≠i]k\b/gi, 'lil bro'],
  [/\bsestra|sest[r≈ô]i[ƒçc]ka\b/gi, 'sis'],
  [/\bbratr|br[a√°]cha\b/gi, 'bro'],
  [/\bkamar[a√°]d\b/gi, 'homie'],
  [/\bk[a√°]mo[≈°s]\b/gi, 'bestie'],
  [/\bhit\b/gi, 'banger'],
  [/\bl[≈æz]e\b/gi, 'cap'],
  [/\bnepravda\b/gi, 'cap'],
  [/\bpravda\b/gi, 'facts']
];

// Slovn√≠k s vysvƒõtlen√≠mi pro Gen-Z v√Ωrazy
const GZ2CZ_EXPLANATIONS = {
  'af': 'As F**k - pou≈æ√≠v√° se ke zd≈Øraznƒõn√≠, nap≈ô. "cool AF" = opravdu super',
  'banger': 'nƒõco v√Ωjimeƒçnƒõ dobr√©ho, hit (hudba, video, z√°≈æitek)',
  'bestie': 'best friend, nejlep≈°√≠ kamar√°d/ka',
  'boomer': 'ƒçlovƒõk nerozumƒõj√≠c√≠ modern√≠m trend≈Øm, star≈°√≠ generace',
  'brain rot': 'hniloba mozku - p≈ô√≠li≈° mnoho ƒçasu s mƒõlk√Ωm obsahem',
  'cancelled': 'zru≈°en√Ω - ztr√°ta podpory kv≈Øli kontroverz√≠m',
  'classy': 'stylov√Ω, elegantn√≠, m√° t≈ô√≠du',
  'cringe': 'trapn√© a nep≈ô√≠jemn√©',
  'crush': 'zamilov√°n√≠, pobl√°znƒõn√≠ do nƒõkoho',
  'dad joke': 'trapn√Ω prvopl√°nov√Ω vtip',
  'delulu': 'mimo realitu, naivn√≠, nesmysln√° oƒçek√°v√°n√≠',
  'drip': 'skvƒõl√Ω smysl pro m√≥du, styl',
  'fail': 'chyba, selh√°n√≠, ne√∫spƒõch',
  'flexit': 'p≈ôedv√°dƒõt se, ƒçasto s materi√°ln√≠m bohatstv√≠m',
  'fomo': 'fear of missing out - strach z toho, ≈æe nƒõco zme≈°k√°te',
  'ghosting': 'ignorov√°n√≠, p≈ôestat odpov√≠dat',
  'goat': 'greatest of all time - nejlep≈°√≠ v≈°ech dob',
  'goofy': 'bl√°zniv√Ω, vtipn√Ω, trochu trapn√Ω ale roztomil√Ω',
  'rizz': 'charisma, ≈°arm, schopnost nƒõkoho okouzlit',
  'sick': 'cool, stylov√©, super (pozitivnƒõ)',
  'sigma': 'nez√°visl√Ω samot√°≈ô, nepot≈ôebuje uzn√°n√≠',
  'shady': 'podez≈ôel√©, ned≈Øvƒõryhodn√©',
  'skibidi': 'divn√©, absurdn√≠, z√°bavn√©',
  'slay': 'perfektn√≠ v√Ωkon, stylov√Ω, mimo≈ô√°dnƒõ √∫spƒõ≈°n√Ω',
  'vibe': 'n√°lada, atmosf√©ra',
  'weirdo': 'podiv√≠n, ƒçlovƒõk vymykaj√≠c√≠ se norm√°m',
  'lit': 'skvƒõl√©, v√Ωborn√©, zaj√≠mav√©',
  'mid': 'pr≈Ømƒõrn√©, meh',
  'bussin': 'v√Ωborn√© (hlavnƒõ j√≠dlo)',
  'based': 'autentick√©, cool, sebevƒõdom√© n√°zory',
  'toxic': 'toxick√© chov√°n√≠',
  'valid': 'dobr√©, solidn√≠, rozumn√©',
  'cope': 'zp≈Øsob vyrovn√°n√≠ se s nƒõƒç√≠m',
  'flex': 'chlubit se, p≈ôedv√°dƒõt se',
  'stan': 'posedl√Ω fanou≈°ek',
  'sus': 'suspicious - podez≈ôel√Ω',
  'cap': 'le≈æ, nen√≠ pravda',
  'no cap': 'fakt, bez kec≈Ø, je to pravda',
  'iykyk': 'if you know you know - kdy≈æ v√≠≈°, tak v√≠≈°',
  'felit': 'tr√°vit ƒças s p≈ô√°teli, pop√≠jet, chillovat',
  'feelovat': 'pocitovƒõ pro≈æ√≠t, c√≠tit',
  'fixnout': 'opravit',
  'buffnout': 'pos√≠lit',
  'nerfnout': 'oslabit',
  'yapping': '≈ævatlat, brblat'
};

const GZ2CZ_WORDS = [
  // Bƒõ≈æn√° angliƒçtina (CEL√â FR√ÅZE PRVN√ç - nejdel≈°√≠ prvn√≠!)
  [/no\s+thoughts,?\s+just\s+vibes\.?/gi, '≈æ√°dn√© my≈°lenky, jenom n√°lada'],
  [/no\s+thoughts,?\s+just/gi, '≈æ√°dn√© my≈°lenky, jenom'],
  [/literally,?\s+no\s+thoughts/gi, 'doslova ≈æ√°dn√© my≈°lenky'],
  [/instant\s+vibe\s+generator/gi, 'gener√°tor n√°lady'],
  
  // Fr√°ze (del≈°√≠ mus√≠ b√Ωt prvn√≠)
  [/no\s+cap/gi, 'fakt, bez kec≈Ø'],
  [/real\s+talk/gi, 'up≈ô√≠mnƒõ'],
  [/skill\s+issue/gi, 'probl√©m se schopnostmi'],
  [/hard\s+carry/gi, 't√°hnout t√Ωm'],
  [/hard\s+W/gi, 'velk√© v√≠tƒõzstv√≠'],
  [/on\s+point/gi, 'p≈ôesn√©'],
  [/chef'?s\s+kiss/gi, 'dokonal√©'],
  [/low\s+effort/gi, 'n√≠zk√© √∫sil√≠'],
  [/not\s+it/gi, '≈°patn√©'],
  [/not\s+deep/gi, 'nen√≠ to slo≈æit√©'],
  [/short\s+walk/gi, 'kr√°tk√° proch√°zka'],
  [/dark\s+mode/gi, 'tmav√Ω re≈æim'],
  [/deep\s+breath/gi, 'hlubok√Ω n√°dech'],
  [/mind\s+reset/gi, 'reset mysli'],
  
  // Verbs (ƒçeskoƒçesk√° Gen-Z slovesa)
  [/fixnout/gi, 'opravit'],
  [/buffnout/gi, 'pos√≠lit'],
  [/nerfnout/gi, 'oslabit'],
  [/shipnout/gi, 'vydat'],
  [/rerollnout/gi, 'zkusit znovu'],
  [/locknout/gi, 'uzamknout'],
  [/pushnout/gi, 'poslat'],
  [/deploynout/gi, 'nasadit'],
  [/scale[\-\s]?nout/gi, '≈°k√°lovat'],
  [/mute[\-\s]?nout/gi, 'ztlumit'],
  [/ghostnout/gi, 'ignorovat'],
  [/cancelnout/gi, 'zru≈°it'],
  [/save[\-\s]?nout/gi, 'ulo≈æit'],
  [/pin[\-\s]?nout/gi, 'p≈ôipnout'],
  [/dropnout/gi, 'pustit'],
  [/grindit/gi, 'd≈ô√≠t'],
  [/resetnout/gi, 'resetovat'],
  [/revive[\-\s]?nout/gi, 'o≈æivit'],
  [/speedrunout/gi, 'rychle projet'],
  [/min[\-\s]?maxnout/gi, 'optimalizovat'],
  [/pivotnout/gi, 'zmƒõnit smƒõr'],
  [/stacknout/gi, 'navrstvit'],
  [/pingnout/gi, 'ozvat se'],
  [/syncnout/gi, 'synchronizovat'],
  [/merge[\-\s]?nout/gi, 'slouƒçit'],
  [/clapnout\s+bug/gi, 'opravit chybu'],
  
  // Bƒõ≈æn√° anglick√° slova (podstatn√° jm√©na)
  [/\bthoughts\b/gi, 'my≈°lenky'],
  [/\bvibes\b/gi, 'n√°lada'],
  [/\binstant\b/gi, 'okam≈æit√Ω'],
  [/\bgenerator\b/gi, 'gener√°tor'],
  
  // Nouns
  [/setup/gi, 'nastaven√≠'],
  [/flow/gi, 'tok'],
  [/mood/gi, 'n√°lada'],
  [/grind/gi, 'd≈ôina'],
  [/energy/gi, 'energie'],
  [/stack/gi, 'vrstva'],
  [/buff/gi, 'pos√≠len√≠'],
  [/nerf/gi, 'oslaben√≠'],
  [/clout/gi, 'vliv'],
  [/brain/gi, 'mozek'],
  [/focus/gi, 'soust≈ôedƒõn√≠'],
  [/playlist/gi, 'playlist'],
  [/deadline/gi, 'term√≠n'],
  [/scope/gi, 'rozsah'],
  [/context/gi, 'kontext'],
  [/cooldown/gi, 'pauza'],
  [/overhead/gi, 'n√°klad'],
  [/latence/gi, 'zpo≈ædƒõn√≠'],
  [/momentum/gi, 'rozjezd'],
  [/checkpoint/gi, 'kontroln√≠ bod'],
  [/meta/gi, 'meta'],
  
  // Tones & slang
  [/skibidi/gi, 'divn√©'],
  [/bussin['"]?/gi, 'v√Ωborn√©'],
  [/rizz/gi, 'charisma'],
  [/based/gi, 'autentick√©'],
  [/slay/gi, 'perfektn√≠'],
  [/cringe/gi, 'trapn√©'],
  [/vibe(s)?/gi, 'n√°lada'],
  [/toxic/gi, 'toxick√©'],
  [/\btea\b/gi, 'drby'],
  [/delulu/gi, 'mimo realitu'],
  [/peak/gi, 'vrchol'],
  [/clean/gi, 'ƒçist√©'],
  [/solid/gi, 'solidn√≠'],
  [/sleek/gi, 'elegantn√≠'],
  [/smooth/gi, 'hladk√©'],
  [/crisp/gi, 'ostr√©'],
  [/\bgas\b/gi, 'super'],
  [/\bsus\b/gi, 'podez≈ôel√©'],
  [/yikes/gi, 'fuj'],
  [/\bdead\b/gi, 'mrtv√©'],
  [/trash/gi, '≈°patn√©'],
  [/iffy/gi, 'nejist√©'],
  [/\boff\b/gi, 'divn√©'],
  [/overkill/gi, 'p≈ôehnan√©'],
  [/\bpain\b/gi, 'bolest'],
  [/cope/gi, 'vyrovn√°v√°n√≠'],
  [/doom/gi, 'z√°huba'],
  [/\bnah\b/gi, 'ne'],
  [/not\s+it/gi, 'to nen√≠ ono'],
  [/basic/gi, 'z√°kladn√≠'],
  [/lukewarm/gi, 'vla≈æn√©'],
  [/\blite\b/gi, 'lehk√©'],
  [/standard/gi, 'standardn√≠'],
  [/neutral/gi, 'neutr√°ln√≠'],
  [/average/gi, 'pr≈Ømƒõrn√©'],
  [/not\s+deep/gi, 'nen√≠ to hlubok√©'],
  [/whatever/gi, 'cokoli'],
  [/so[\-\s]?so/gi, 'tak tak'],
  [/ok[\-\s]?ish/gi, 'tak akor√°t'],
  [/hard\s+W/gi, 'velk√© v√≠tƒõzstv√≠'],
  [/on\s+point/gi, 'p≈ôesn√©'],
  [/chef'?s\s+kiss/gi, 'dokonal√©'],
  [/low\s+effort/gi, 'm√°lo √∫sil√≠'],
  
  // Bƒõ≈æn√° anglick√° slov√≠ƒçka (kr√°tk√°, ƒçasto se vyskytuj√≠c√≠)
  [/\bjust\b/gi, 'jenom'],
  [/\bliterally\b/gi, 'doslova'],
  [/\bno\b/gi, '≈æ√°dn√©'],
  
  // Openery a bƒõ≈æn√© v√Ωrazy
  [/\bfr\b/gi, 'v√°≈ænƒõ'],
  [/\bngl\b/gi, 'up≈ô√≠mnƒõ'],
  [/\bidk\b/gi, 'nev√≠m'],
  [/\bimo\b/gi, 'podle mƒõ'],
  [/\bbtw\b/gi, 'mimochodem'],
  [/\bfyi\b/gi, 'pro tvou informaci'],
  [/\birl\b/gi, 'v re√°lu'],
  [/lowkey/gi, 'trochu'],
  [/highkey/gi, 'hodnƒõ'],
  [/\bmid\b/gi, 'pr≈Ømƒõrn√©'],
  [/goated/gi, 'legend√°rn√≠'],
  [/kino/gi, 'filmov√©'],
  [/heat/gi, '≈æhav√©'],
  [/valid/gi, 'dobr√©'],
  [/drip/gi, 'styl'],
  [/mega/gi, 'hodnƒõ'],
  [/fire/gi, 'super'],
  [/\bcap\b/gi, 'le≈æ'],
  [/\bbro\b/gi, 'br√°cho'],
  [/k(√°|a)mo/gi, 'kamar√°de'],
  
  // Nov√© v√Ωrazy ze slovn√≠ku
  [/\baf\b/gi, 'extr√©mnƒõ'],
  [/banger/gi, 'hit'],
  [/bestie/gi, 'nejlep≈°√≠ k√°mo≈°'],
  [/boomer/gi, 'star≈°√≠ generace'],
  [/brain\s+rot/gi, 'hniloba mozku'],
  [/cancelled/gi, 'zru≈°en√Ω'],
  [/classy/gi, 'elegantn√≠'],
  [/crush/gi, 'zamilov√°n√≠'],
  [/dad\s+joke/gi, 'trapn√Ω vtip'],
  [/eboy|egirl/gi, 'emo styl'],
  [/fail/gi, 'ne√∫spƒõch'],
  [/finsta/gi, 'fale≈°n√Ω Instagram'],
  [/flexit/gi, 'p≈ôedv√°dƒõt se'],
  [/fomo/gi, 'strach zme≈°kat'],
  [/gaslighting/gi, 'manipulace'],
  [/ghosting/gi, 'ignorov√°n√≠'],
  [/goat/gi, 'nejlep≈°√≠'],
  [/goofy/gi, 'bl√°zniv√Ω'],
  [/red\s+flag/gi, 'varovn√Ω sign√°l'],
  [/green\s+flag/gi, 'pozitivn√≠ sign√°l'],
  [/beige\s+flag/gi, 'neutr√°ln√≠ sign√°l'],
  [/shady/gi, 'podez≈ôel√©'],
  [/shitpost/gi, 'nesmysln√Ω p≈ô√≠spƒõvek'],
  [/situationship/gi, 'vztah nevztah'],
  [/snowflake/gi, 'p≈ôecitlivƒõl√Ω'],
  [/swag/gi, 'styl'],
  [/troll(ing)?/gi, 'provokov√°n√≠'],
  [/vanilla/gi, 'nudn√©'],
  [/weirdo/gi, 'podiv√≠n'],
  [/academic\s+victim/gi, 'uƒçen√≠ nejde'],
  [/academic\s+weapon/gi, 'dobr√Ω ve ≈°kole'],
  [/ate\s+and\s+left\s+no\s+crumbs/gi, 'udƒõlal skvƒõle'],
  [/baddie/gi, 'drsn√° ≈æena'],
  [/\bbae\b/gi, 'mil√°ƒçek'],
  [/baller/gi, '√∫spƒõ≈°n√Ω'],
  [/ballin/gi, 'luxusn√≠ ≈æivot'],
  [/black\s+cat/gi, 'chladn√° energie'],
  [/bodyshaming/gi, 'ur√°≈æen√≠ tƒõla'],
  [/bombex/gi, 'super'],
  [/booknout/gi, 'zarezervovat'],
  [/boujee|bougie/gi, 'luxusn√≠'],
  [/\bbruh\b/gi, 'k√°mo'],
  [/built\s+different/gi, 'talentovan√Ω'],
  [/chillovat/gi, 'relaxovat'],
  [/\bchill\b/gi, 'v klidu'],
  [/cooking/gi, 'dƒõlat dob≈ôe'],
  [/let\s+(him|her|them)\s+cook/gi, 'nech ho/ji tvo≈ôit'],
  [/coping\s+mechanism/gi, 'zp≈Øsob vyrovn√°n√≠'],
  [/cringovat/gi, 'b√Ωt trapn√Ω'],
  [/death\s+stare/gi, 'mrtvoln√Ω pohled'],
  
  // Actions z lexikonu
  [/reset/gi, 'restart'],
  [/vypnout\s+notifikace/gi, 'vypnout notifikace'],
  [/d(√°|a)t\s+pauzu/gi, 'd√°t pauzu'],
  [/stretch/gi, 'prota≈æen√≠'],
  [/nadejchat\s+vzduch/gi, 'nadejchat vzduch'],
  [/vym(ƒõ|e)nit\s+playlist/gi, 'vymƒõnit playlist'],
  [/p(√≠|i)t\s+vodu/gi, 'p√≠t vodu'],
  [/short\s+walk/gi, 'kr√°tk√° proch√°zka'],
  [/sn(√≠|i)(≈æ|z)it\s+jas/gi, 'sn√≠≈æit jas'],
  [/dark\s+mode/gi, 'tmav√Ω re≈æim'],
  [/offline\s+m(√≥|o)d/gi, 'offline re≈æim'],
  [/deep\s+breath/gi, 'hlubok√Ω n√°dech'],
  [/rychl(e|ej)\s+detox\s+s(√≠|i)t(√≠|i)/gi, 'rychl√Ω detox s√≠t√≠'],
  [/proklepat\s+prsty/gi, 'proklepat prsty'],
  [/mind\s+reset/gi, 'reset mysli'],
  [/rychl(e|ej)\s+re[\-\s]?sync/gi, 'rychl√° synchronizace'],
  [/st(≈ô|r)ihnout\s+mini\s+(√∫|u)kol/gi, 'udƒõlat mini√∫kol'],
  [/odlo(≈æ|z)it\s+perfekcionismus/gi, 'odlo≈æit perfekcionismus'],
  [/zapsat\s+\d+\s+my(≈°|s)lenky/gi, 'zapsat my≈°lenky'],
  [/deg(e)?≈°/gi, 'hloup√Ω'],
  [/dope/gi, 'super'],
  [/edgovat/gi, 'nap√≠nat'],
  [/fame/gi, 'slavn√Ω'],
  [/fancy/gi, 'noblesn√≠'],
  [/feelovat/gi, 'c√≠tit'],
  [/fel(√°|a)ci/gi, 'k√°mo≈°i'],
  [/felit/gi, 'posedƒõt'],
  [/\bfit\b/gi, 'outfit'],
  [/fit\s+check/gi, 'uk√°zka outfitu'],
  [/\bflex\b/gi, 'chlubit se'],
  [/\bflop\b/gi, 'ne√∫spƒõch'],
  [/fruity/gi, 'ne √∫plnƒõ hetero'],
  [/gaslight/gi, 'manipulovat'],
  [/gatekeep/gi, 'kontrolovat p≈ô√≠stup'],
  [/ghostnout/gi, 'ignorovat'],
  [/girl\s+dinner/gi, 'snacky m√≠sto j√≠dla'],
  [/girl\s+math/gi, '≈æensk√° logika'],
  [/girlboss/gi, '√∫spƒõ≈°n√° ≈æena'],
  [/glow[\-\s]?up/gi, 'zmƒõna k lep≈°√≠mu'],
  [/glow[\-\s]?down/gi, 'zmƒõna k hor≈°√≠mu'],
  [/golden\s+retriever/gi, 'mil√Ω ƒçlovƒõk'],
  [/gymrat/gi, 'z√°visl√Ω na cviƒçen√≠'],
  [/highlight/gi, 'vrchol'],
  [/hits\s+different/gi, 'jinak p≈Øsob√≠'],
  [/\bhoe\b/gi, 'lehk√° d√≠vka'],
  [/\bhot\b/gi, 'atraktivn√≠'],
  [/\bhuh\b/gi, 'co?'],
  [/ch(√°|a)br/gi, 'br√°cha'],
  [/\bchad\b/gi, 'alfa samec'],
  [/ch(√°|a)lka/gi, 'j√≠dlo'],
  [/ch(√°|a)lovat/gi, 'j√≠st'],
  [/checkuju|checknout/gi, 'zkontrolovat'],
  [/chicago/gi, 'm√≠sto pohody'],
  [/chicken\s+legs/gi, 'slab√© nohy'],
  [/\bick\b/gi, 'odpudiv√©'],
  [/imagine/gi, 'p≈ôedstav si'],
  [/its\s+giving/gi, 'vypad√° skvƒõle'],
  [/karen/gi, 'protivn√° ≈æena'],
  [/legit/gi, 'doopravdy'],
  [/legit\s+check/gi, 'kontrola pravosti'],
  [/\bmatch\b/gi, 'padnout si'],
  [/\bmeh\b/gi, 'nic moc'],
  [/\bmood\b/gi, 'n√°lada'],
  [/mother(ing)?/gi, 'kr√°lovna'],
  [/nefeelovat/gi, 'nec√≠t√≠m to'],
  [/netflix\s+and\s+chill/gi, 'sex'],
  [/niche/gi, 'unik√°tn√≠'],
  [/\bnope\b/gi, 'ne'],
  [/passenger\s+princess/gi, 'spolujezdec jako kr√°l'],
  [/period/gi, 'teƒçka'],
  [/photo\s+dump/gi, 'v√≠ce fotek'],
  [/pick\s+me\s+girl/gi, 'holka shazuj√≠c√≠ jin√©'],
  [/pregame/gi, 'p√≠t p≈ôed akc√≠'],
  [/puff(√≠|i)k/gi, 'elektronick√° cigareta'],
  [/\bqueen\b/gi, 'kr√°lovna'],
  [/resting\s+bitch\s+face/gi, 'odsuzuj√≠c√≠ pohled'],
  [/roman\s+empire/gi, 'neust√°le p≈ôem√Ω≈°let'],
  [/savage/gi, 'divo≈°sk√©'],
  [/\bscam\b/gi, 'podvod'],
  [/serving/gi, 'vypadat skvƒõle'],
  [/shade/gi, 'podez≈ôel√©'],
  [/\bship\b/gi, 'p√°rovat'],
  [/shipovat/gi, 'podporovat vztah'],
  [/shoutout/gi, 'vyzdvihnut√≠'],
  [/side\s+eye/gi, 'boƒçn√≠ oko'],
  [/\bsimp\b/gi, 'submisivn√≠ mu≈æ'],
  [/sip\s+tea/gi, 'hlt√°n√≠ drb≈Ø'],
  [/\bskip\b/gi, 'vynechat'],
  [/smash\s+or\s+pass/gi, 'ano nebo ne'],
  [/\bstan\b/gi, 'posedl√Ω fanou≈°ek'],
  [/solulu/gi, '≈ôe≈°en√≠'],
  [/sugar\s+(baby|daddy|mamma)/gi, 'dotovan√Ω vztah'],
  [/sweet\s+treat/gi, 'dezert√≠k'],
  [/tahat\s+se/gi, 'v√≠dat se'],
  [/spill\s+the\s+tea/gi, '≈ôekni drby'],
  [/the\s+feminine\s+urge/gi, '≈æensk√© nutk√°n√≠'],
  [/thirst\s+trap/gi, 'sv≈Ødn√° fotka'],
  [/tinderdate/gi, 'rande z Tinderu'],
  [/\btrigger\b/gi, 'spou≈°tƒõƒç'],
  [/trolling/gi, 'provokov√°n√≠'],
  [/turn\s+on|turn\s+off/gi, 'p≈ôita≈æliv√©/nep≈ôita≈æliv√©'],
  [/vyghostit/gi, 'ignorovat'],
  [/\bwack\b/gi, 'nudn√Ω'],
  [/white\s+girl\s+music/gi, 'Taylor Swift'],
  [/who\s+let\s+(him|her)\s+cook/gi, 'to je skvƒõl√©'],
  [/\bwoke\b/gi, 'politicky korektn√≠'],
  [/yapping/gi, '≈ævatlat'],
  [/\byass\b/gi, 'ano'],
  [/zaddy/gi, 'sexy star≈°√≠ mu≈æ'],
  [/zne(≈æ|z)ivit\s+se/gi, 'sebevra≈æda']
];

function looksGenZ(s){
  // Roz≈°√≠≈ôen√° detekce Gen-Z slangu vƒçetnƒõ ƒçesk√Ωch hybrid≈Ø a struktur
  const genZPatterns = [
    /\b(skibidi|rizz|based|cringe|bussin|cap|no cap|slay|fr|ngl|mid|drip|goated|delulu|lowkey|highkey|vibe|toxic|valid|fire|kino|heat|sus|yikes|cope|peak|clean|sleek|smooth|gas|lit|W|L)\b/i,
    /\b(fixnout|buffnout|nerfnout|shipnout|rerollnout|pushnout|deploynout|grindit|ghostnout|locknout|clapnout|resetnout|speedrunout|pivotnout|stacknout|pingnout|syncnout)\b/i,
    /\b(setup|flow|mood|grind|energy|stack|buff|nerf|clout|focus|deadline|scope|context|cooldown|overhead|latence|momentum|checkpoint|meta|xp|loot|combo)\b/i,
    /\b(bro|k√°mo|real talk|ok listen|true story|side note|btw|heads up|no jokes|literally|honestly|okay tak≈æe)\b/i,
    /\b(skill issue|hard W|hard L|on point|chef'?s kiss|low effort|brain lag|not it|ok-ish|so-so)\b/i,
    /(fr fr|on god|no cap|you know|like,)/i
  ];
  
  // Pokud se shoduje s jak√Ωmkoli Gen-Z patternem
  return genZPatterns.some(pattern => pattern.test(s));
}

function applyReplacements(s, pairs){
  let out = s;
  // Aplikuj v≈°echny nahrazen√≠ postupnƒõ
  for (const [re, to] of pairs){
    const regex = new RegExp(re.source, re.flags);
    let matches = [];
    let match;
    
    // Najdi v≈°echny matches
    while ((match = regex.exec(out)) !== null) {
      matches.push({index: match.index, length: match[0].length, original: match[0], replacement: to});
      // Pokud nen√≠ global flag, ukonƒçi
      if (!regex.global) break;
    }
    
    // Aplikuj v≈°echny nahrazen√≠ od konce, aby se neposunuly indexy
    for (let i = matches.length - 1; i >= 0; i--) {
      const m = matches[i];
      let replacement = m.replacement;
      // zachov√°n√≠ prvn√≠ kapitalizace
      if (m.original[0] === m.original[0].toUpperCase() && replacement.length) {
        replacement = replacement[0].toUpperCase() + replacement.slice(1);
      }
      out = out.substring(0, m.index) + replacement + out.substring(m.index + m.length);
    }
  }
  return out;
}

function translateLocal(text, direction){
  let s = String(text||'');
  if (!s.trim()) return "";
  
  console.log('[translateLocal] Input:', text, 'Direction:', direction);
  
  if (direction === 'normal_to_gz'){
    const original = s;
    s = applyReplacements(s, CZ2GZ_PHRASES);
    console.log('[translateLocal] After CZ2GZ_PHRASES:', s);
    s = applyReplacements(s, CZ2GZ_WORDS);
    console.log('[translateLocal] After CZ2GZ_WORDS:', s);
    // P≈ôidej Gen-Z struktury a fillery do vƒõty
    s = addGenZFlair(s);
    console.log('[translateLocal] Final result:', s);
    return s;
  }
  if (direction === 'gz_to_normal'){
    // Nejd≈ô√≠v vyƒçisti Gen-Z fillery a struktury
    s = removeGenZFlair(s);
    // Pak p≈ôelo≈æ Gen-Z slova do ƒçe≈°tiny
    s = applyReplacements(s, GZ2CZ_WORDS);
    return s;
  }
  // autodetekce
  return looksGenZ(s) ? translateLocal(s,'gz_to_normal') : translateLocal(s,'normal_to_gz');
}

// Odstran√≠ Gen-Z fillery a strukturn√≠ prvky z textu (JEMNƒö)
function removeGenZFlair(text){
  let result = text;
  
  // Odstranƒõn√≠ JEN nejbƒõ≈ænƒõj≈°√≠ch filler≈Ø, kter√© nemƒõn√≠ v√Ωznam
  // Odstranit openers na zaƒç√°tku (ale zachovat v√Ωznam)
  result = result.replace(/^(jako|literally|honestly|okay tak≈æe|ok listen|hele)\s*,?\s*/i, '');
  
  // Odstranit suffix fillery na konci
  result = result.replace(/,?\s*(fr fr|no cap|on god|ngl)\s*\.?\s*$/i, '');
  
  // Odstranit "like" a "you know" kdy≈æ jsou jako fillery (ne ve smyslov√© ƒç√°sti)
  result = result.replace(/,\s*(like|you know)\s*,/gi, ', ');
  
  // Odstranit skibidi kdy≈æ je jen jako filler
  result = result.replace(/,?\s*skibidi (vibes|moment|energy)\s*/gi, ' ');
  
  // Vyƒçisti nadbyteƒçn√© mezery a interpunkci
  result = result
    .replace(/\s+/g, ' ')
    .replace(/\s*,\s*/g, ', ')
    .replace(/\s*\.\s*/g, '. ')
    .replace(/\s+([.,!?])/g, '$1')
    .replace(/^[,\s]+/, '')
    .replace(/[,\s]+$/, '')
    .trim();
  
  // Velk√© p√≠smeno na zaƒç√°tku
  if(result.length > 0){
    result = result[0].toUpperCase() + result.slice(1);
  }
  
  return result;
}

// P≈ôid√° Gen-Z struktury a fillery do p≈ôelo≈æen√© vƒõty (JEDNODU≈†≈†√ç)
function addGenZFlair(text){
  let result = text;
  
  // Men≈°√≠ ≈°ance na fillery - jen 20-30% ≈°ance
  const rand = Math.random();
  
  // Buƒè p≈ôidej prefix (20% ≈°ance)
  if(rand < 0.2){
    const prefixes = ['jako', 'literally', 'honestly'];
    result = prefixes[Math.floor(Math.random()*prefixes.length)] + ', ' + result;
  }
  // Nebo suffix (dal≈°√≠ 20% ≈°ance)
  else if(rand < 0.4){
    const suffixes = ['fr', 'no cap', 'ngl'];
    result = result + ', ' + suffixes[Math.floor(Math.random()*suffixes.length)];
  }
  
  return result;
}

// p≈ôepis p≈Øvodn√≠ translate(): nejd≈ô√≠v lok√°ln√≠, serverless fallback ti≈°e
async function translate(text, direction){
  const local = translateLocal(text, direction);
  // kdy≈æ se nƒõco zmƒõnilo, vra≈• hned
  if (local && local.toLowerCase() !== String(text||'').toLowerCase()) return local;

  try{
    const r = await fetch('/.netlify/functions/translate',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ text, direction })
    });
    if (r.ok){
      const j = await r.json();
      if (j && j.translated) return j.translated;
    }
  }catch(e){}
  return local || String(text||'');
}
/* ========= konec lok√°ln√≠ho p≈ôekladaƒçe ========= */

async function showAutoTranslation(source){
  const el = document.getElementById('quoteTranslated');
  
  // Pokud nen√≠ AUTO nebo u≈æ bƒõ≈æ√≠ p≈ôeklad, skonƒçi
  if(!AUTO){ 
    el.style.display='none'; 
    el.textContent=''; 
    return; 
  }
  
  // Zabr√°n√≠me v√≠cen√°sobn√Ωm p≈ôeklad≈Øm najednou
  if(translationInProgress){
    return;
  }
  
  // Kontrola, ≈æe m√°me co p≈ôekl√°dat
  if(!source || !source.trim()){
    el.style.display='none';
    el.textContent='';
    return;
  }
  
  translationInProgress = true;
  
  try{
    const dir = looksGenZ(source) ? 'gz_to_normal' : 'normal_to_gz';
    const out = await translate(source, dir);
    
    // Zkontrolujeme znovu AUTO, proto≈æe u≈æivatel mohl checkbox zmƒõnit bƒõhem p≈ôekladu
    if(!AUTO){
      el.style.display='none';
      el.textContent='';
      return;
    }
    
    if(out && out.trim() && out.trim().toLowerCase() !== source.trim().toLowerCase()){
      el.textContent = '‚Ü≥ P≈ôeklad: ' + out;
      el.style.display='block';
    } else {
      el.style.display='none';
      el.textContent='';
    }
  } catch(e){
    console.error('Translation error:', e);
    el.style.display='none';
    el.textContent='';
  } finally {
    translationInProgress = false;
  }
}

async function init(){
  await loadLexicon();

  // Mood selector removed - always use 'genz' mode
  MODE = 'genz';
  localStorage.setItem('mode', MODE);

  const chk=document.getElementById('chkAutoTrans');
  chk.checked = AUTO;
  chk.onchange = async ()=>{
    AUTO = chk.checked;
    localStorage.setItem('autoTrans', AUTO?'1':'0');
    const transEl = document.getElementById('quoteTranslated');
    
    if(!AUTO){ 
      // Vypneme p≈ôeklad
      transEl.style.display='none'; 
      transEl.textContent='';
    } else { 
      // Zapneme p≈ôeklad - zobraz√≠me loading a pak p≈ôelo≈æ√≠me
      transEl.textContent = '‚Ü≥ P≈ôekl√°d√°m...';
      transEl.style.display='block';
      const currentQuote = document.getElementById('quote').textContent;
      if(currentQuote && currentQuote.trim()){
        await showAutoTranslation(currentQuote);
      }
    }
  };

  const url = new URLSearchParams(location.search);
  const q=url.get('q'); const m=url.get('mode'); if(m){ MODE=m; localStorage.setItem('mode',MODE); apply(); }
  const first = q?decodeURIComponent(q):compose();
  await setQuoteTyped(first, false);

  document.getElementById('next').onclick=async()=>{
    const text = compose();
    await setQuoteTyped(text);
  };
  // Copy button (guarded)
  const copyEl = document.getElementById('copy');
  if (copyEl) {
    copyEl.onclick = async () => {
      try {
        await navigator.clipboard.writeText(location.href);
      } catch (e) {
        console.warn('Clipboard write failed', e);
      }
      const c = document.getElementById('copy'); if (c) { const prev = c.textContent; c.textContent = 'Zkopƒçeno ‚úÖ'; setTimeout(()=>{ c.textContent = prev; }, 1100); }
    };
  }

  // Share button - prefer #shareMain, fallback to #share (guarded)
  (function(){
    const shareEl = document.getElementById('shareMain') || document.getElementById('share');
    if (!shareEl) return;
    shareEl.onclick = async () => {
      try{
        const quote = (document.getElementById('quote') && document.getElementById('quote').textContent) || '';
        if (navigator.share){
          await navigator.share({title:'TY VOLE .wtf', text: quote, url: location.href});
        } else {
          await navigator.clipboard.writeText(location.href);
        }
        const prev = shareEl.textContent;
        shareEl.textContent = 'Odesl√°no ‚úÖ';
        setTimeout(()=>{ shareEl.textContent = prev; }, 1100);
      }catch(e){
        console.warn('Share failed', e);
      }
    };
  })();

  // Translator bottom sheet
  const sheet=document.getElementById('sheet'), back=document.getElementById('backdrop');
  const openSheet=()=>{sheet.classList.add('open');back.classList.add('show');};
  const closeSheet=()=>{sheet.classList.remove('open');back.classList.remove('show');};
  document.getElementById('btnSheet').onclick=openSheet;
  document.getElementById('closeSheet').onclick=closeSheet; back.onclick=closeSheet;

  // === Obousmƒõrn√Ω automatick√Ω p≈ôekladaƒç ===
  (() => {
    const $normal  = document.getElementById('ta-normal');
    const $skibidi = document.getElementById('ta-skibidi');
    const $clear   = document.getElementById('clearBtn');
    
    if (!$normal || !$skibidi) return; // safety guard

    // ochrana proti nekoneƒçn√© smyƒçce p≈ôi zrcadlen√≠
    let isUpdating = false;

    // jednoduch√Ω debounce
    const debounce = (fn, ms = 250) => {
      let t; 
      return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
    };
    
    // Funkce pro glow animaci p≈ôekladaƒçe
    function pulseGlow(){
      const box = document.getElementById('translator-box');
      if (!box) return;
      box.classList.remove('translated');
      void box.offsetWidth; // reflow
      box.classList.add('translated');
    }

    // === P≈ôekladov√© funkce (pou≈æ√≠vaj√≠ existuj√≠c√≠ translate()) ===
    async function toSkibidi(text){
      if (!text.trim()) return '';
      return await translate(text, 'normal_to_gz');
    }

    async function toNormal(text){
      if (!text.trim()) return '';
      return await translate(text, 'gz_to_normal');
    }

    // === Handlery vstup≈Ø ===
    const handleNormalInput = debounce(async () => {
      if (isUpdating) return;
      isUpdating = true;
      const src = $normal.value;
      $skibidi.value = await toSkibidi(src);
      pulseGlow(); // vizualizace p≈ôekladu
      isUpdating = false;
    }, 220);

    const handleSkibidiInput = debounce(async () => {
      if (isUpdating) return;
      isUpdating = true;
      const src = $skibidi.value;
      $normal.value = await toNormal(src);
      pulseGlow();
      isUpdating = false;
    }, 220);

    $normal.addEventListener('input', handleNormalInput);
    $skibidi.addEventListener('input', handleSkibidiInput);

    $clear?.addEventListener('click', () => {
      $normal.value = '';
      $skibidi.value = '';
    });
  })();
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

// Service Worker Registration is now handled by update-chip.js
</script>

<!-- Share System Scripts - defer ensures DOM is ready -->
<script src="lib/i18n.js" defer></script>
<script src="lib/analytics.js" defer></script>
<script src="lib/ab-test.js" defer></script>
<script src="lib/share.js" defer></script>
<script type="module">
  // Import vibe-share for new JPG + shortlink sharing
  import { dropToChat } from './lib/vibe-share.js';
  window.vibeShare = { dropToChat };
</script>

<!-- Update Chip Script -->
<script src="lib/update-chip.js" defer></script>

<script defer>
// Initialize share system - defer ensures DOM + other scripts are ready
(() => {
  // Track A/B test variant assignment
  if (window.abTest) window.abTest.trackCTAVariant();
  
  // Update CTA text based on A/B variant and language
  const shareMainBtn = document.getElementById('shareMain');
  const shareMainText = document.getElementById('shareMainText');
  const downloadText = document.getElementById('downloadText');
  const copyText = document.getElementById('copyText');
  const ctaMicrocopy = document.getElementById('ctaMicrocopy');
  
  function updateCTATexts() {
    // Update all button texts with RANDOM Gen-Z variants! üî•
    if (!window.i18n || !window.i18n.getRandomButtonText) {
      console.warn('i18n not ready, keeping fallback texts');
      return;
    }
    
    try {
      // Each button gets random Gen-Z text on EVERY page load
      shareMainText.textContent = window.i18n.getRandomButtonText('share');
      downloadText.textContent = window.i18n.getRandomButtonText('download');
      copyText.textContent = window.i18n.getRandomButtonText('copyLink');
    } catch (e) {
      console.error('Error updating CTA texts:', e);
    }
  }
  
  function showMicrocopy() {
    if (!window.i18n || !window.i18n.getRandomMicrocopy) return;
    
    const text = window.i18n.getRandomMicrocopy();
    ctaMicrocopy.textContent = text;
    ctaMicrocopy.style.display = 'block';
    // Re-trigger animation
    ctaMicrocopy.style.animation = 'none';
    setTimeout(() => {
      ctaMicrocopy.style.animation = '';
    }, 10);
  }
  
  // Update texts immediately with random variants (scripts have defer so they're loaded)
  updateCTATexts();
  
  // Share button - NEW: Use vibe-share with JPG + shortlink
  shareMainBtn.onclick = async () => {
    const quote = document.getElementById('quote').textContent;
    
    // Track analytics
    if (window.analytics) {
      window.analytics.ctaClick(window.abTest?.cta?.getVariant?.() || 'default');
    }
    
    // Build target URL with current quote
    const baseUrl = window.location.origin + window.location.pathname;
    const params = new URLSearchParams({
      q: quote,
      mode: MODE || 'genz'
    });
    const targetUrl = `${baseUrl}?${params.toString()}`;
    
    // Use new vibe-share system with JPG + shortlink
    if (window.vibeShare?.dropToChat) {
      try {
        await window.vibeShare.dropToChat(quote, targetUrl);
      } catch (error) {
        console.error('[Share] dropToChat failed:', error);
        // Fallback to old system
        if (window.shareSystem?.share) {
          await window.shareSystem.share(quote);
        }
      }
    } else {
      // Fallback if module not loaded yet
      if (window.shareSystem?.share) {
        await window.shareSystem.share(quote);
      }
    }
  };
  
  // Download button
  document.getElementById('downloadCard').onclick = async () => {
    const quote = document.getElementById('quote').textContent;
    window.shareSystem.currentQuote = quote;
    await window.shareSystem.downloadCard();
  };
  
  // Copy link button - keep original functionality but track
  const originalCopyHandler = document.getElementById('copy').onclick;
  document.getElementById('copy').onclick = async () => {
    window.analytics.copyLink();
    await window.shareSystem.copyLink();
  };
  
  // Show microcopy when new quote is generated
  const originalNextHandler = document.getElementById('next').onclick;
  document.getElementById('next').onclick = async function() {
    await originalNextHandler.call(this);
    showMicrocopy();
  };
  
  // Show microcopy on initial load
  setTimeout(showMicrocopy, 500);
  
  // Generate card for current quote on load (preload)
  setTimeout(async () => {
    const quote = document.getElementById('quote').textContent;
    if (quote && quote !== '‚Ä¶naƒç√≠t√°m fresh hl√°≈°ku‚Ä¶') {
      try {
        await window.shareSystem.generateCardImage(quote);
        console.log('[Share] Card preloaded');
      } catch (e) {
        console.warn('[Share] Preload failed:', e);
      }
    }
  }, 1000);
})();
</script>

<!-- PWA Install Banner -->
<script src="/install.js?v=5"></script>

<!-- PWA Diagnostic Logs (temporary) -->
<!-- === PWA Update Chip === -->
<div id="update-chip" style="display:none; position:fixed; right:calc(16px + var(--safe-right)); bottom:calc(16px + var(--safe-bottom)); z-index:9999;">
  <button id="update-chip-btn" style="border-radius:999px; padding:8px 12px; font-size:12px; background:#000; color:#fff; box-shadow:0 6px 16px rgba(0,0,0,.2); border:none; cursor:pointer;">Nov√° verze ¬∑ Aktualizovat</button>
</div>

<script>
// PWA logging (kept for debugging)
if ('serviceWorker' in navigator) {
  console.log('[PWA] Display mode:', window.matchMedia('(display-mode: standalone)').matches ? 'standalone' : 'browser');
}

window.addEventListener('beforeinstallprompt', (e) => {
  console.log('[PWA] beforeinstallprompt fired ‚úÖ', e);
});

window.addEventListener('appinstalled', () => {
  console.log('[PWA] appinstalled event ‚úÖ');
});
</script>
<!-- === /PWA Update Chip === -->

<!-- Daily Tracks -->
<script src="/lib/daily-tracks.js" defer></script>

</body>
</html>

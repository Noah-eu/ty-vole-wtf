<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TYKáč – chat</title>
<style>
  :root{--bg:#0b0b11;--ink:#f3f3f8;--muted:#a7a7b6;--line:#252536;--card:#11121a;--accent:#9DFF00;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 ui-sans-serif,system-ui;
    min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}
  header,footer{padding:12px 16px;border-bottom:1px solid var(--line)} footer{border-top:1px solid var(--line);border-bottom:0}
  .wrap{max-width:900px;margin:0 auto;width:100%}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:13px;color:var(--muted)}
  .pill.sel{border-color:var(--accent);color:var(--ink);font-weight:800}
  .chat{padding:12px 16px} .msg{max-width:760px;margin:10px 0;padding:10px 14px;border:1px solid var(--line);border-radius:14px;background:#11121a}
  .me{margin-left:auto;background:#0f1a10;border-color:#1f3a20}
  .trans{margin-top:6px;color:var(--muted);font-size:14px}
  .input{display:flex;gap:8px} input[type=text]{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#0f1016;color:var(--ink)}
  button{border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer} .go{background:var(--accent);color:#0b0b11}
</style>
</head>
<body>
  <header><div class="wrap row">
    <strong>TY VOLE .wtf – Chat</strong>
    <div class="row" style="margin-left:auto">
      <span class="pill">Vstup:</span>
      <button class="pill sel" id="inNormal">Normální</button>
      <button class="pill" id="inGenz">Gen-Z</button>
      <span class="pill">Překlad:</span>
      <button class="pill sel" id="trNever">Nikdy</button>
      <button class="pill" id="trOnClick">Na klik</button>
      <button class="pill" id="trAlways">Vždy</button>
    </div>
  </div></header>

  <main class="chat wrap" id="chat"></main>

  <footer><div class="wrap input">
    <input id="text" type="text" placeholder="Napiš zprávu…"/>
    <button id="send" class="go">Poslat</button>
  </div></footer>

<script>
let inputStyle = localStorage.getItem('inStyle') || 'normal';       // normal | genz
let translateMode = localStorage.getItem('trMode') || 'never';      // never | click | always

const elChat = document.getElementById('chat');
const elTxt = document.getElementById('text');

function setSel(id,on){ document.getElementById(id).classList.toggle('sel',on); }

function applyToggles(){
  setSel('inNormal', inputStyle==='normal'); setSel('inGenz', inputStyle==='genz');
  setSel('trNever', translateMode==='never'); setSel('trOnClick', translateMode==='click'); setSel('trAlways', translateMode==='always');
}
applyToggles();

document.getElementById('inNormal').onclick=()=>{ inputStyle='normal'; localStorage.setItem('inStyle',inputStyle); applyToggles(); }
document.getElementById('inGenz').onclick=()=>{ inputStyle='genz';   localStorage.setItem('inStyle',inputStyle); applyToggles(); }
document.getElementById('trNever').onclick=()=>{ translateMode='never'; localStorage.setItem('trMode',translateMode); applyToggles(); }
document.getElementById('trOnClick').onclick=()=>{ translateMode='click'; localStorage.setItem('trMode',translateMode); applyToggles(); }
document.getElementById('trAlways').onclick=()=>{ translateMode='always'; localStorage.setItem('trMode',translateMode); applyToggles(); }

function addMsg(text, me=false, translation=''){
  const div=document.createElement('div'); div.className='msg'+(me?' me':''); div.textContent=text;
  if(translation){
    const t=document.createElement('div'); t.className='trans'; t.textContent='↳ '+translation;
    if(translateMode==='click'){ t.style.display='none'; div.style.cursor='pointer'; div.onclick=()=>{ t.style.display = t.style.display==='none'?'block':'none'; }; }
    div.appendChild(t);
  }
  elChat.appendChild(div); elChat.scrollTop = elChat.scrollHeight;
}

async function translate(text, direction){
  try{
    const r = await fetch('/.netlify/functions/translate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text, direction})});
    const j = await r.json(); return j.translated || '';
  }catch{ return ''; }
}

async function send(){
  const q = elTxt.value.trim(); if(!q) return;
  elTxt.value=''; addMsg(q,true);

  // reply style je opak k inputu (když píšeš normálně, odpověď Gen-Z)
  const replyStyle = (inputStyle==='normal') ? 'genz' : 'normal';
  const withTranslation = (translateMode!=='never');

  try{
    const r = await fetch('/.netlify/functions/chat',{method:'POST',headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ q, inputStyle, replyStyle, withTranslation })
    });
    const j = await r.json();

    let reply = j.reply || '…';
    let translation = j.translation || '';

    // fallback: pokud funkce neposlala translation a režim to chce, dožádej přes /translate
    if(!translation && withTranslation){
      const direction = (replyStyle==='genz') ? 'gz_to_normal' : 'normal_to_gz';
      translation = await translate(reply, direction);
    }

    addMsg(reply,false, translateMode==='never' ? '' : translation);
  }catch(e){
    addMsg('Ou, něco se rozbilo. Zkus to znova později.', false);
  }
}

document.getElementById('send').onclick=send;
elTxt.addEventListener('keydown',e=>{ if(e.key==='Enter'){ send(); }});
</script>
</body>
</html>

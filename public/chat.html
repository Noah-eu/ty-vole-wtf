<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tyk√°ƒç ‚Äì chat</title>
<meta name="description" content="Gen-Z chat (Tyk√°ƒç). Kr√°tk√©, trefn√©, trochu drz√© odpovƒõdi.">
<!-- PWA Meta -->
<link rel="manifest" href="/manifest.webmanifest?v=5">
<meta name="theme-color" content="#111111">
<link rel="icon" href="/icons/icon-192.v5.png" sizes="192x192">
<link rel="apple-touch-icon" href="/icons/icon-192.v5.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root{
    /* New design system colors */
    --bg-0:#0A0A0A;
    --bg-1:#080808;
    --bg-2:#0E0E0E;
    --text:#F4F4F4;
    --muted:#BDBDBD;

    --lime:#B8FF4D;
    --cyan:#27F1E2;
    --pink:#FF5FA6;

    --card:#121212;
    --radius:18px;
    --gap:22px;
    
    /* Legacy compat */
    --ink:var(--text);
    --bg:var(--bg-0);
    --accent:var(--lime);
    --ink-dark:#0c0c10;
    --line:#252536;
  }
  *{box-sizing:border-box}
  html, body{
    /* Animovan√Ω gradient jako na hlavn√≠ str√°nce */
    background: radial-gradient(120% 120% at 10% 0%, #0d0d0d 0%, #070707 45%, #0e0e0e 100%);
    background-size: 140% 140%;
    color: var(--text);
  }
  @media (prefers-reduced-motion:no-preference){
    body{ animation: bgShift 16s ease-in-out infinite alternate; }
    @keyframes bgShift{ from{ background-position: 0% 0%; } to{ background-position: 100% 50%; } }
  }
  body{margin:0;font:16px/1.5 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Inter,Roboto,Arial;position:relative}
  
  /* MEGA BACKGROUND WORDMARK - viditeln√Ω p≈ôes pr≈Øsvitn√© elementy */
  .bg-wordmark{
    position:fixed; inset:0; display:flex; flex-direction:column; justify-content:space-between;
    pointer-events:none; z-index:0; overflow:hidden; padding:5vh 0;
  }
  .bg-wordmark span{
    font-weight:900; white-space:nowrap;
    font-size:14vh;
    letter-spacing:-0.8vw;
    color:#ffe0f0;
    opacity:.32;
    text-shadow:0 18px 90px rgba(255,224,240,.6);
    user-select:none;
  }
  .bg-top{
    align-self:flex-start;
    transform:translateX(-8vw) rotate(-4deg) scaleX(0.7) scaleY(2.5);
  }
  .bg-bottom{
    align-self:flex-end;
    transform:translateX(8vw) rotate(3deg) scaleX(0.7) scaleY(2.5);
  }
  
  /* Wrap bez black overlays */
  .wrap{height:100dvh;display:grid;grid-template-rows:auto 1fr auto;position:relative;z-index:1}
  .wrap::before{ content:none!important; }
  
  /* Header - pr≈Øhledn√Ω bez ƒçern√©ho p√°su */
  header{
    display:flex;align-items:center;gap:12px;padding:10px 14px;
    background: rgba(0,0,0,0);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: none;
    box-shadow: none;
  }
  header::before{ content:none!important; }
  header a{color:var(--accent);text-decoration:none;font-weight:900}
  header .title{font-weight:900;letter-spacing:.01em}
  .chips{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid color-mix(in oklab, #fff, transparent 85%);color:var(--muted);background:rgba(18,18,18,.50);padding:6px 10px;border-radius:999px;font-size:13px;white-space:nowrap}
  .chip.switch{cursor:pointer}
  
  /* Messages area - pr≈Øhledn√© pozad√≠ */
  #log{padding:12px 14px 96px;overflow:auto;scroll-behavior:smooth;background:transparent}
  .msg{max-width:860px;margin:0 auto 12px auto;display:flex;gap:10px}
  
  /* Bubliny - polopr≈Øhledn√© s glassmorphism */
  .bubble{
    border-radius:16px;
    padding:10px 14px;
    background: rgba(18,18,18,.72);
    border: none;
    color: var(--text);
    box-shadow: 0 6px 22px rgba(0,0,0,.28);
  }
  .you .bubble{
    margin-left:auto;
    background: linear-gradient(90deg, var(--cyan), #7DF7EB);
    color:#062;
  }
  .ai .bubble{
    background: rgba(18,18,18,.72);
  }
  
  .avatar, .pfp{width:28px;height:28px;border-radius:50%;background:#1f1f1f;flex:0 0 auto;display:grid;place-items:center;font-weight:700;color:#ddd}
  .trans{color:var(--muted);font-size:13px;margin-top:6px}
  .typing{display:inline-block;min-width:12px;border-right:2px solid var(--ink);animation:blink 1s steps(1,end) infinite}
  @keyframes blink{50%{border-color:transparent}}
  
  /* Footer - jen jemn√Ω gradient fade */
  footer{
    position: sticky; bottom: 0; left: 0; right: 0;
    padding: 10px 12px 14px;
    background: linear-gradient(180deg, transparent, rgba(0,0,0,.18));
    border: none;
    box-shadow: none;
  }
  footer::before{ content:none!important; }
  
  form{max-width:960px;margin:0 auto;display:grid;grid-template-columns:1fr auto;gap:10px}
  
  /* Input - polopr≈Øhledn√Ω */
  textarea{
    width:100%;min-height:54px;max-height:36dvh;resize:vertical;
    background: rgba(18,18,18,.70);
    color:var(--text);
    border: 1px solid color-mix(in oklab, #fff, transparent 80%);
    border-radius:16px;
    padding:12px 14px;
    font:15px/1.5 ui-sans-serif,system-ui;
  }
  textarea::placeholder{ color: var(--muted); }
  
  /* Po≈°li button - neon glow jako na hlavn√≠ */
  button{
    appearance:none;
    border:none;
    cursor:pointer;
    padding:12px 16px;
    border-radius:14px;
    font-weight:800;
    color:#072;
    background: linear-gradient(90deg, var(--lime), #CFFF85);
    box-shadow: 0 10px 28px rgba(184,255,77,.18);
    transform: translateZ(0);
  }
  @media (prefers-reduced-motion:no-preference){
    button:hover{ filter: drop-shadow(0 0 10px rgba(184,255,77,.32)); }
  }
  
  .row{max-width:960px;margin:8px auto 0 auto;display:flex;gap:10px;align-items:center;justify-content:space-between}
  .left{display:flex;gap:10px;align-items:center}
  .hint{color:var(--muted);font-size:12px}
  
  /* Typewriter cursor animace */
  .tvl-cursor::after{
    content:'';
    display:inline-block;
    width:10px; height:1.1em; margin-left:2px;
    border-right:2px solid #9ae6b4;
    animation:tvl-blink .9s step-end infinite;
  }
  @keyframes tvl-blink{ 50%{ border-right-color:transparent; } }
</style>
</head>
<body>
<!-- big background wordmark -->
<div class="bg-wordmark">
  <span class="bg-top">TY VOLE</span>
  <span class="bg-bottom">.WTF</span>
</div>

<div class="wrap">
  <header>
    <a href="/">&larr; zpƒõt</a>
    <div class="title">Tyk√°ƒç ‚Äì chat</div>
    <div class="chips">
      <label class="chip switch" title="Zobraz√≠ p≈ôeklad pod odpovƒõd√≠">
        <input id="chkTrans" type="checkbox" style="vertical-align:-2px;margin-right:6px">Dej p≈ôeklad
      </label>
      <div id="modeChip" class="chip switch" title="P≈ôepnout vibe">Vibe: Edgy</div>
    </div>
  </header>

  <main id="log" aria-live="polite"></main>

  <footer>
    <form id="f">
      <textarea id="q" placeholder="Hoƒè sem t√©ma‚Ä¶ t≈ôeba '≈°kola je pain, co s t√≠m' üò≠" aria-label="Napi≈° zpr√°vu Tyk√°ƒçovi"></textarea>
      <button id="send" type="submit" aria-label="Odeslat zpr√°vu">Po≈°li</button>
    </form>
    <div class="row">
      <div class="left">
        <span class="chip">#skibidi</span><span class="chip">#rizz</span><span class="chip">#based</span><span class="chip">#drip</span>
      </div>
      <div class="hint">Tip: p≈ôepni ‚ÄûVibe‚Äú pro klidnƒõj≈°√≠ styl.</div>
    </div>
  </footer>
</div>

<script>
const elLog = document.getElementById('log');
const elForm = document.getElementById('f');
const elQ = document.getElementById('q');
const elTrans = document.getElementById('chkTrans');
const elMode = document.getElementById('modeChip');

let MODE = (localStorage.getItem('chatMode') || 'edgy'); // edgy by default
let SHOW_TRANSLATION = localStorage.getItem('chatTrans') === '1';

// Typewriter utility - p√≠≈°e text po znac√≠ch do elementu
async function typeInto(el, text, cps = 30){
  // cps = chars per second
  const delay = 1000 / Math.max(1, cps);
  el.textContent = '';
  for (let i = 0; i < text.length; i++){
    el.textContent += text[i];
    await new Promise(r => setTimeout(r, delay));
  }
}

function attachBlinkCursor(el){
  el.classList.add('tvl-cursor');
}

function detachBlinkCursor(el){
  el.classList.remove('tvl-cursor');
}

elTrans.checked = SHOW_TRANSLATION;
elTrans.onchange = () => {
  SHOW_TRANSLATION = elTrans.checked;
  localStorage.setItem('chatTrans', SHOW_TRANSLATION ? '1':'0');
};
const applyMode = () => elMode.textContent = 'Vibe: ' + (MODE === 'edgy' ? 'Edgy' : 'Safe');
applyMode();
elMode.onclick = () => {
  MODE = MODE === 'edgy' ? 'family_friendly' : 'edgy';
  localStorage.setItem('chatMode', MODE);
  applyMode();
};

function msg(role, html, translated=''){
  const row = document.createElement('div');
  row.className = 'msg ' + (role === 'user' ? 'you':'ai');

  const pfp = document.createElement('div');
  pfp.className = 'pfp';
  pfp.textContent = role === 'user' ? 'U' : 'T';

  const b = document.createElement('div');
  b.className = 'bubble';
  b.innerHTML = html;

  if (translated){
    const t = document.createElement('div');
    t.className = 'trans';
    t.textContent = '‚Ü≥ P≈ôeklad: ' + translated;
    b.appendChild(t);
  }

  row.appendChild(pfp);
  row.appendChild(b);
  elLog.appendChild(row);
  elLog.scrollTop = elLog.scrollHeight;
  return b;
}

// Vytvo≈ô√≠ bublinu pro AI zpr√°vu s typewriter efektem
async function msgTyped(role, text, translated='', cps = 28){
  const row = document.createElement('div');
  row.className = 'msg ' + (role === 'user' ? 'you':'ai');

  const pfp = document.createElement('div');
  pfp.className = 'pfp';
  pfp.textContent = role === 'user' ? 'U' : 'T';

  const b = document.createElement('div');
  b.className = 'bubble';
  
  row.appendChild(pfp);
  row.appendChild(b);
  elLog.appendChild(row);
  
  // Typewriter efekt s blikaj√≠c√≠m kurzorem
  attachBlinkCursor(b);
  await typeInto(b, text, cps);
  detachBlinkCursor(b);
  
  // P≈ôidej p≈ôeklad pokud existuje
  if (translated){
    const t = document.createElement('div');
    t.className = 'trans';
    t.textContent = '‚Ü≥ P≈ôeklad: ' + translated;
    b.appendChild(t);
  }
  
  elLog.scrollTop = elLog.scrollHeight;
  return b;
}

function typingBubble(){
  const el = msg('assistant', '<span class="typing"></span>');
  return {
    set(text){ el.innerHTML = text; },
    done(){ /* nothing */ }
  };
}

// prvn√≠ lehce drzej opener s typewriter efektem
setTimeout(async () => {
  await msgTyped('assistant', "ƒåau, tak co ≈ôe≈°√≠≈°? Hoƒè to sem, ≈æ√°dn√Ω slohy ‚Äì jedeme short & spicy.", '', 35);
}, 1000);

async function apiChat(q){
  const r = await fetch('/.netlify/functions/chat?mode='+encodeURIComponent(MODE), {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ q })
  });
  if(!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}

async function apiTranslate(text){
  const r = await fetch('/.netlify/functions/translate', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ text, direction:'gz_to_normal' })
  });
  if(!r.ok) return '';
  const j = await r.json();
  return j.translated || '';
}

elForm.onsubmit = async (e) => {
  e.preventDefault();
  const q = elQ.value.trim();
  if(!q) return;
  elQ.value = '';

  msg('user', q);

  const live = typingBubble();
  try{
    const data = await apiChat(q);
    let reply = (data.reply || '').trim();
    if(!reply) reply = "Mid ot√°zka, zkus konkr√©tnƒõji.";
    
    // Sma≈æeme "loading" bublinu
    live.set('');
    const bubble = live;
    
    // Vytvo≈ô√≠me novou zpr√°vu s typewriter efektem
    let translated = '';
    if(SHOW_TRANSLATION){
      translated = await apiTranslate(reply);
    }
    
    // Odstran√≠me loading bublinu z DOMu
    const loadingMsg = bubble.parentElement?.parentElement;
    if(loadingMsg) loadingMsg.remove();
    
    // Vytvo≈ô√≠me novou zpr√°vu s typewriter animac√≠
    await msgTyped('assistant', reply, translated, 28);
    
  }catch(e){
    live.set("Rip, spadla s√≠≈•. Dej je≈°tƒõ jednou.");
  }
};
</script>

<!-- PWA Install Banner -->
<script src="/install.js?v=5"></script>

<!-- === PWA Update Toast === -->
<style>
#pwa-update-toast {
  position: fixed;
  left: 1rem; right: 1rem; bottom: 1rem;
  z-index: 9999;
  display: none;
  background: #111;
  color: #fff;
  border: 1px solid #333;
  border-radius: 12px;
  padding: .9rem 1rem;
  box-shadow: 0 10px 30px rgba(0,0,0,.4);
  font: 14px system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
  justify-content: space-between;
  align-items: center;
}
#pwa-update-toast button {
  margin-left: .8rem;
  border: 0;
  border-radius: 10px;
  padding: .5rem .9rem;
  background: linear-gradient(90deg, #22ff99, #00ffaa);
  color: #000;
  font-weight: 600;
  cursor: pointer;
}
</style>

<div id="pwa-update-toast">
  Nov√° verze aplikace je k dispozici. 
  <button id="pwa-update-apply">Aktualizovat</button>
</div>

<script>
(async () => {
  if (!('serviceWorker' in navigator)) return;

  const toast = document.getElementById('pwa-update-toast');
  const btn = document.getElementById('pwa-update-apply');

  const showToast = () => toast.style.display = 'flex';
  const hideToast = () => toast.style.display = 'none';

  // Registrace nebo z√≠sk√°n√≠ existuj√≠c√≠ho SW
  const reg = await navigator.serviceWorker.register('/sw.js');

  // Funkce, kter√° nab√≠dne update, pokud je SW waiting
  function offerUpdate(reg) {
    if (!reg.waiting) return;
    showToast();
    btn.onclick = () => {
      reg.waiting.postMessage({ type: 'SKIP_WAITING' });
    };
  }

  // Kdy≈æ se najde nov√° verze SW
  reg.addEventListener('updatefound', () => {
    const newSW = reg.installing;
    newSW?.addEventListener('statechange', () => {
      if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
        offerUpdate(reg);
      }
    });
  });

  // Pokud u≈æ m√°me waiting SW p≈ôi naƒçten√≠
  offerUpdate(reg);

  // Jakmile se aktivuje nov√Ω SW, reload
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    hideToast();
    window.location.reload();
  });

  // Voliteln√©: pravidelnƒõ zkus update
  setInterval(() => reg.update().catch(()=>{}), 30 * 60 * 1000);
})();
</script>
<!-- === /PWA Update Toast === -->

</body>
</html>
